# <스프링 웹 MVC>

# [WEB 서버, WAB(Web Application Server)]
## 웹 서버(Web Server)
* HTTP 기반으로 동작
* 정적 리소스 제공, 기타 부가기능
* 정적(파일) HTML, CSS, JS, 이미지, 영상들을 제공해줌
* 예) NGINX, APACHE

## 웹 애플리케이션 서버(WAS - Web Application Server)
* HTTP 기반으로 동작
* 웹 서버 기능 포함 + (정적 리소스 제공 가능)
* 프로그램 코드를 실행해서 애플리케이션 로직 수행
  * 동적 HTML, HTTP API(JSON)
  * 서블릿, JSP, 스프링 MVC
* 예) 톰캣(Tomcat), Jetty, Undertow

## 웹 서버, 웹 애플리케이션 서버(WAS)의 차이
* 웹 서버는 정적 리소스(파일) 제공, WAS는 애플리케이션 로직까지 실행하여 제공
* 사실은 둘의 용어 및 경계가 모호하다.
  * 웹 서버도 프로그램을 실행하는 기능을 포함하기도 함(플러그인 설치)
  * 웹 애플리케이션 서버도 웹 서버의 기능을 제공한다.
* 자바는 서블릿 컨테이너 기능을 제공하면 WAS
  * 서블릿 없이 자바코드를 실행하는 서버 프레임워크도 있다.
* WAS는 애플리케이션 코드를 실행하는데 더 특화되어 있다.

## 웹 시스템 구성 - WAS, DB (가장 간단한 조함)
* WAS, DB만으로 시스템 구성 가능
* WAS는 정적 리소스, 애플리케이션 로직 모두 제공 가능

한 개의 WAS만 사용하는 경우
* WAS가 너무 많은 역할을 담당, 서버 과부하 우려
* 가장 비싼 애플리케이션 로직이 정적 리소스 때문에 수행이 어려울 수 있다.
* WAS 장애시 오류 화면도 노출 불가능 (WAS자체가 장애가나면 오류도 확인할 수 없음)   
  (애플리케이션 로직은 DB, 및 다른 서버 호출을 위한 비즈니스 로직이 있기때문에 비싸다고 표현)

## 웹 시스템 구성(일반적) - WEB, WAS, DB
* 정적 리소스는 웹 서버가 처리
* 웹 서버는 애플리케이션 로직같은 동적인 처리가 필요하면 WAS에 요청을 위임
* WAS는 중요한 애플리케이션 로직 처리 전담   
* 또한 효율적인 리소스 관리에 좋다
  * 정적 리소스가 많이 사용되면 Web 서버 증설
  * 애플리케이션 리소스가 많이 사용되면 WAS 증설
* 웹 서버는 잘 죽지 않음(단순한 정적파일 제공이므로)
* WAS, DB 장애시 WEB서버가 오류 화면 제공 가능
* 단순히 API만 주고받는 경우 웹 서버 없어도 됨(화면에 표시할것이 없으므로)

<br>

# [서블릿]
* 서블릿은 특정 HTTP 메소드로 서버가 요청을 받게되면 일어나는 동작들(**동작은 PPT 확인**) 중에서   
  비즈니스 로직 실행(데이터베이스에 저장 요청)을 제외한 나머지 부분들을 전부 커버해준다.(서버를 지원하는 WAS들이)
## 서블릿의 특징
```java
@Webservlet(name = "helloServlet", urlPatterns = "/hello")
public class HelloServlet extends HttpServlet {
  @Override
  protected void service(HttpServletRequest request, HttpServletResponse response) {
    //애플리케이션 로직
  }
}
```
* urlPatterns(/hello)의 URL이 호출되면 서블릿 코드가 실행된다.
* HTTP 요청 정보를 편리하게 사용할 수 있는 HttpServletRequest
* HTTP 응답 정보를 편리하게 제공할 수 있는 HttpServletResponse
* 개발자는 HTTP 스펙을 매우 편리하게 사용할 수 있지만, HTTP 스펙을 기본적으로 알아야 사용할때 편리하다.

##  HTTP 요청, 응답 흐름
* HTTP 요청 시
  * WAS : Request, Response 객체 새로 만든 후 서블릿 객체 호출(누가 호출하는지 모르므로 항상 새로 생성)
  * 개발자는 Request 객체에서 HTTP 요청 정보를 꺼내어 사용, Response 객체에는 HTTP 응답정보를 입력한다.
  * WAS는 Response 객체에 담겨있는 내용으로 HTTP 응답 정보를 생성한다.

## 서블릿 컨테이너 (톰캣처럼 서블릿을 지원하는 WAS를 서블릿 컨테이너라 한다.)
* 개발자는 서블릿 객체를 직접 생성하는것이 아닌 코드만 만듦
* WAS안에 서블릿 컨테이너에서 서블릿 객체를 자동으로 생성, 초기화, 호출, 종료하는 생명주기를 관리 해준다.
* 서블릿 객체는 **싱글톤으로 관리됨**
  * 고객의 요청이 올 때 마다 객체 생성 == 비효율
  * 최초 로딩 시점에 서블릿 객체를 미리 만들어두고 재활용
  * 모든 고객 요청은 동일한 서블릿 객체 인스턴스에 접근
  * **공유 변수 사용 주의(Stateless 해야 함)**
  * 서블릿 컨테이너 종료시 함께 종료됨
* **동시 요청을 위한 멀티 스레드 처리 지원** : 중요한 특징(개발자는 크게 신경쓰지 않아도 됨)

<br>

# [동시 요청 - 멀티 쓰레드]
트래픽이 많아질 경우 사용할 수 있는 기법
* 클라이언트에서 서버로 요청을 하게 되면 TCP/IP커넥션이 연결되고 Servlet을 호출한다.
* 그렇다면 Servlet은 누가 호출할까? **쓰레드**

## 쓰레드
* 애플리케이션 코드를 각각 순차적으로 실행함
* 자바 메인 메서드를 처음 실행하면 main이라는 이름의 쓰레드가 실행된다.
* 쓰레드가 없으면 자바 애플리케이션의 실행이 불가능하다.
* 쓰레드는 한번에 하나의 코드 라인만 수행함
* 동시 처리가 필요하면 쓰레드를 추가로 생성해줘야한다.

단일 요청 - 쓰레드 하나 사용
* 요청이 하나 오면 WAS에서 쓰레드를 하나 할당하고 이를 이용해 Servlet 코드 실행

다중 요청 - 쓰레드 하나 사용
* 요청1, 요청2가 들어올때 요청1에서 쓰레드의 Servlet처리가 지연될때 요청 2가 들어오면?
* 쓰레드를 사용할 수 있을때까지 기다림
* 결국 둘다 죽어버리는 상황이 발생함
* 이것을 해결하기 위해서 신규 쓰레드를 생성한다.
* 즉 **요청이 올 때 마다 쓰레드를 생성한다.**

## 요청이 올 때 마다 쓰레드 생성의 장단점
**장점**
* 동시 요청 처리 가능
* 리소스(CPU, 메모리)가 허용할 때 까지 처리 가능
* 하나의 쓰레드가 지연돼도, 나머지 쓰레드 정상 동작

**단점**
 * 생성 비용이 매우 비쌈
   * 요청 올 때마다 생성 -> 응답 속도 늦어짐
 * 컨텍스트 스위칭 비용이 발생 (쓰레드1에서 쓰레드2로 전환할때 발생하는 비용)   
   쓰레드는 실제적으로는 동시가 아닌 순차적으로 처리하지만 매우 빠른 CPU의 속도로 동시처리처럼 보임
* 쓰레드 생성에 제한이 없다.
  * CPU, 메모리가 임계점을 넘어서 서버가 다운되는 상황 발생함

## 쓰레드 풀(Thread Pool)
하나의 풀장을 생각(특정 양의 쓰레드를 pool안에 만들어 놓음)
* 요청이 오면 쓰레드 풀에서 쓰레드를 요청한다.
* 요청이 종료되면 쓰레드는 쓰레드 풀로 다시 반납함
* 즉 미리 만들어서 넣어놓고 빌려쓰고 가져다 놓는 방식
* 서버가 200개의 요청이 한계라면 200개를 넘어서는 요청들은 대기하거나, 거절할 수 있다.

## 쓰레드 풀 - 요청 마다 쓰레드 생성의 단점 보안
특징
* 필요한 쓰레드를 쓰레드 풀에 보관하고 관리
* 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다. 톰캣은 최대 200개 기본 설정(변경 가능)

사용
* 쓰레드가 필요시, 이미 생성된 쓰레드를 쓰레드 풀에서 꺼내 사용
* 사용 종료하면 쓰레드 풀에 해당 쓰레드를 반납
* 최대 쓰레드가 모두 사용중이어서 쓰레드 풀에 쓰레드가 없으면?
  * 기다리는 요청은 거절하거나 특정 숫자만큼만 대기하도록 설정

장점
* 쓰레드가 미리 생성되어 있음, 쓰레드를 생성하고 종료하는 비용이 절약되고, 응답 시간 빠르다.
* 생성 가능한 쓰레드의 최대치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다.

## 쓰레드 풀 - 성능 튜닝 팁(실무)
* WAS의 주요 튜닝 포인트는 최대 쓰레드(max thread)의 수이다.
* 너무 낮게 설정
  * 동시 요청 많으면, 서버 리소스 여유롭지만, 클라이언트는 응답 지연
* 너무 높게 설정
  * 동시 요청 많으면, CPU, 메모리 리소스 임계점 초과로 서버 다운
* 장애 발생시?
  * 클라우드면 일단 서버부터 늘리고, 이후에 튜닝
  * 클라우드가 아니면 열심히 튜닝
  
## 쓰레드 풀의 적정 숫자는?
* 애플리케이션 로직의 복잡도, CPU, 메모리, IO 리소스 상황에 따라 모두 다름
* 성능 테스트
  * 최대한 실제 서비스와 유사하게 성능 테스트 시도
  * 툴: 아파치 ab. 제이미터, nGrinder
  
## 핵심 - WAS의 멀티 쓰레드 지원
* 개발자는 멀티 쓰레드 관련 코드를 신경쓰지 않아도 된다.
* 개발자는 마치 싱글 쓰레드 프로그래밍을 하듯이 편리하게 소스 코드를 개발
* 멀티 쓰레드 환경이므로 싱글톤 객체(서블릿, 스프링 빈)는 주의해서 사용(Stateless하게 사용)